#!/bin/bash

# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚  TITAN XANMOD ULTIMATE - SMART EDITION       â”‚
# â”‚  Fitur: Auto-Detect Virtualization (Anti-Fail)â”‚
# â”‚  Logic: Only allow Kernel Install on KVM     â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# Pastikan Root
if [[ $EUID -ne 0 ]]; then
   echo "Script harus dijalankan sebagai root!" 
   exit 1
fi

# === KONFIGURASI WARNA ===
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[0;33m'
export BLUE='\033[0;34m'
export PURPLE='\033[0;35m'
export CYAN='\033[0;36m'
export LIGHT='\033[0;37m'
export NC='\033[0m'

CONFIG_FILE="/etc/sysctl.conf"
BACKUP_FILE="/etc/sysctl.conf.bak.$(date +%F_%T)"

# === FUNGSI DETEKSI VIRTUALISASI (SMART CHECK) ===
get_virt_type() {
    # Cek arsitektur
    ARCH=$(uname -m)
    # Cek virtualisasi
    VIRT=$(systemd-detect-virt 2>/dev/null)
    
    if [[ "$VIRT" == "" ]]; then VIRT="unknown"; fi
    echo "$VIRT|$ARCH"
}

# === INFO SISTEM ===
get_os_info() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME="$PRETTY_NAME"
    else
        OS_NAME=$(uname -s)
    fi
    echo "$OS_NAME"
}

# === TAMPILAN HEADER (DASHBOARD) ===
show_banner() {
    clear
    opsy=$(get_os_info)
    kern=$(uname -r)
    
    # Ambil Info Virt
    VIRT_DATA=$(get_virt_type)
    VIRT_TYPE=$(echo $VIRT_DATA | cut -d'|' -f1)
    ARCH_TYPE=$(echo $VIRT_DATA | cut -d'|' -f2)

    # Cek Status TCP
    CURRENT_ALGO=$(sysctl -n net.ipv4.tcp_congestion_control 2>/dev/null || echo "Unknown")
    
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC} ${LIGHT}â—ˆ Informasi Sistem â—ˆ ${NC}${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW} âž½ OS         : $opsy ${NC}"
    echo -e "${YELLOW} âž½ Kernel     : $kern ${NC}"
    # Tampilkan Tipe VPS
    if [[ "$VIRT_TYPE" == "kvm" || "$VIRT_TYPE" == "oracle" || "$VIRT_TYPE" == "vmware" ]] && [[ "$ARCH_TYPE" == "x86_64" ]]; then
        echo -e "${YELLOW} âž½ Tipe VPS   : ${GREEN}${VIRT_TYPE^^} (Support Kernel)${NC}"
    else
        echo -e "${YELLOW} âž½ Tipe VPS   : ${RED}${VIRT_TYPE^^} (Not Support Kernel)${NC}"
    fi
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo -e "${YELLOW}â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC} ${LIGHT}â—ˆ Status Jaringan â—ˆ ${NC}${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”${NC}"
    echo -e "${YELLOW} âž½ TCP Algo   : ${GREEN}${CURRENT_ALGO^^}${NC}"
    if [[ "$kern" == *"xanmod"* ]]; then
        echo -e "${YELLOW} âž½ Engine     : ${CYAN}XANMOD HIGH PERF${NC}"
    else
        echo -e "${YELLOW} âž½ Engine     : ${RED}STANDARD LINUX${NC}"
    fi
    echo -e "${YELLOW}â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜${NC}"
    echo " âž½ TITAN XANMOD SMART (Auto-Detect KVM/LXC)"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}

# === SENI SELEBRASI ===
show_success_art() {
    local msg="$1"
    clear
    echo -e "${GREEN}â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£€â£€â£€â£´â ·â£¶â£„â£€â €â €â €â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¼â£¿â£·â£¾â Ÿâ ›â ‹â â €â ˆâ ‰â ›â£¿â£¦â¡€â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â ˆâ ‰â£¡â¡´â ¶â£¤â ¶â ·â£¦â €â£€â£ˆâ »â£¿â¡€â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£³â£¾â£¯â €â €â €â €â£¤â¡ˆâ ‰â ‰â¢¹â¡‡â¢¹â£·â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â£€â£€â €â €â €â €â €â €â €â €â¢˜â£¿â ‹â£¤â¡„â €â£¤â €â¢€â¡ˆâ “â €â£¼â£¿â£„â¢¸â£¿â €â €â €â €â €â €"
    echo -e "â €â €â €â£´â¡¿â ›â ›â£¿â¡§â €â €â €â €â €â €â£¼â¡Ÿâ €â ›â¢¡â¡¾â ‹â €â ¸â ‡â €â €â£¾â£¿â£¿â£¾â Ÿâ €â €â €â €â €â €"
    echo -e "â €â €â¢¸â£¿â €â €â¢°â£¿â ‡â €â €â €â €â €â €â£¿â¡‡â¢€â¡€â ˜â —â €â €â£¤â¡€â €â €â ˆâ ›â¢¿â£¿â €â €â €â €â €â €â €"
    echo -e "â¢€â£ â£¨â£¿â£†â €â ¹â£¿â¡„â €â €â €â €â €â €â¢¸â£¿â ¹â ¯â£¿â£’â£šâ£­â ¿â¡Ÿâ €â €â¢€â£ â£¾â¡¿â €â €â €â €â €â €â €"
    echo -e "â£¿â ›â ‰â ‰â ›â ³â¢¦â¡ˆâ¢¿â£¦â£€â €â €â €â €â €â¢»â£·â¡€â ˜â ›â ƒâ €â €â €â¢€â£´â£¿â£Ÿâ â €â €â €â €â €â €â €â €"
    echo -e "â£¿â ¶â ¶â ¶â ¦â£¤â£¨â¡‡â €â£¿â¡¿â¢·â£¶â£¶â£¦â£´â£¾â£¿â¡Ÿâ ¶â£¤â£€â£€â¡€â¢˜â£¿â â¢¹â¡Ÿâ ¿â£·â£¦â£€â €â €â €â €â €"
    echo -e "â£¿â£¤â£¤â£¤â£€â£€â¢™â¡†â£°â¢â¡‡â €â €â ˆâ ‰â ‰â €â €â ³â£„â¡ˆâ ›â ›â ›â ‹â â£€â£¼â ƒâ €â €â ™â »â£¿â£¦â¡€â €â €"
    echo -e "â£¿â¡…â¢°â£„â ˆâ ‰â£»â¢â¡½â£¸â ƒâ €â €â €â €â €â €â €â €â ˆâ ™â ›â£¦â €â €â¢¹â¡‹â â €â €â €â €â €â ˆâ »â£¿â£†â €"
    echo -e "â ˜â »â£¶â£­â£¿â£¿â£¿â£Ÿâ£±â Ÿâ €â €â €â €â¢€â£ â£¾â ‡â €â €â €â €â¢¹â €â €â ˆâ¡‡â €â €â¢¿â €â €â €â €â €â ˆâ¢»â¡‡"
    echo -e "â €â €â €â ‰â ‰â ‰â ›â ›â ¿â£·â¡–â ’â£¶â¡¿â ›â£¿â €â €â €â €â €â €â ¸â¡‡â €â €â¢¹â €â €â¢¸â¡†â£´â¡–â €â €â €â €â£¿"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¿â¡†â €â €â €â €â €â €â¡‡â €â €â¢¸â¡†â €â ˆâ£¿â â €â €â €â €â£°â ‡"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â£¿â£§â¡€â €â €â €â €â €â¡‡â €â €â €â¡‡â£€â£´â¢¿â£€â¡€â €â €â£°â¡â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â¡â ™â ³â ¶â ¦â£¤â£¤â¡‡â €â €â €â ›â ‰â €â¢¸â ‰â ™â¢·â£¾â¡Ÿâ â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ¸â£¿â¡‡â €â €â €â €â €â €â €â €â €â €â €â¢€â£ â£¾â¡†â£€â£¼â¡¿â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â ™â ·â¢¦â£¤â£„â£€â£€â£ â£¤â£¤â¡¶â ¾â ›â ‰â¢¸â£‡â£¹â£¿â ‡â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â¡Ÿâ €â €â €â €â ˆâ ‰â ‰â ‰â£„â €â €â €â €â €â €â£¿â£¿â â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¿â¡‡â €â €â €â €â €â €â €â£¾â ƒâ €â €â €â €â €â €â£¿â¡¿â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â¢°â£¿â €â €â €â €â €â €â €â£¼â¡‡â €â €â €â €â €â €â¢ â£¿â¡‡â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â €â£¾â¡â €â €â €â €â €â €â£¸â£¿â£‡â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â €â£¼â£¿â â €â €â €â €â €â¢ â£¿â£¿â£¿â €â €â €â €â €â €â£¾â¡¿â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢ â£¿â¡‡â €â €â €â €â €â €â£¾â¡¿â¢¸â¡Ÿâ €â €â €â €â €â¢°â£¿â¡‡â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â €â €â €â €â €â €â£¸â£¿â ƒâ¢¸â¡‡â €â €â €â €â €â£¼â£¿â €â €â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â¢¸â£¿â£€â €â €â €â¢€â£´â£¿â ƒâ €â¢¸â£·â£¦â£¤â£¤â£¤â£´â£¿â£·â£¤â¡€â €â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â£¿â£¿â£¿â£¿â£¿â£¿â£¿â â â €â €â ˆâ »â¡¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â¡†â €â €â €â €"
    echo -e "â €â €â €â €â €â €â €â €â €â €â €â »â¢¿â¡¿â£¿â£¿â Ÿâ â €â €â €â €â €â €â €â €â €â ‰â ‰â ‰â ‰â ‰â ‰â €â €â €â €â €${NC}"
    echo -e ""
    echo -e "${PURPLE}\n[ $msg ]\n${NC}"
}

print_info() { echo -e "${BLUE}âž½ $1${NC}"; }
print_error() { echo -e "${RED}âœ˜ âœ˜ $1${NC}"; }
print_success() { echo -e "${GREEN}âœ” $1${NC}"; }

# === BAGIAN 1: INSTALL KERNEL XANMOD (ENGINE) ===
install_xanmod() {
    # 1. CEK VIRTUALISASI (SMART CHECK)
    VIRT_DATA=$(get_virt_type)
    VIRT_TYPE=$(echo $VIRT_DATA | cut -d'|' -f1)
    ARCH_TYPE=$(echo $VIRT_DATA | cut -d'|' -f2)

    if [[ "$VIRT_TYPE" != "kvm" && "$VIRT_TYPE" != "oracle" && "$VIRT_TYPE" != "vmware" ]]; then
        print_error "VPS Anda menggunakan Virtualisasi: ${VIRT_TYPE^^}"
        echo -e "${RED}Kernel Xanmod TIDAK BISA diinstall di OpenVZ/LXC Container.${NC}"
        echo -e "${YELLOW}Silakan langsung pilih MENU 2 (TITAN Tuning).${NC}"
        echo -e "${YELLOW}Menu 2 tetap Powerfull untuk VPS tipe ini.${NC}"
        read -p "Tekan Enter untuk kembali..."
        return
    fi
    
    if [[ "$ARCH_TYPE" != "x86_64" ]]; then
        print_error "Arsitektur CPU Anda: $ARCH_TYPE"
        echo -e "${RED}Xanmod hanya support AMD/Intel 64bit (x86_64).${NC}"
        echo -e "${YELLOW}Silakan langsung pilih MENU 2.${NC}"
        read -p "Tekan Enter untuk kembali..."
        return
    fi

    # 2. PROSES INSTALL (Jika Lolos Cek)
    print_info "Memulai Instalasi Kernel Xanmod..."
    
    if [ ! -f /etc/debian_version ]; then
        print_error "Script ini hanya untuk Debian/Ubuntu!"
        return
    fi

    print_info "Mengupdate repository..."
    apt-get update -qq && apt-get install wget gpg gawk -y -qq

    print_info "Menambahkan GPG Key Xanmod..."
    wget -qO - https://dl.xanmod.org/gpg.key | gpg --dearmor --yes -o /usr/share/keyrings/xanmod-archive-keyring.gpg

    print_info "Menambahkan Repository Xanmod..."
    echo 'deb [signed-by=/usr/share/keyrings/xanmod-archive-keyring.gpg] http://deb.xanmod.org releases main' | tee /etc/apt/sources.list.d/xanmod-kernel.list

    print_info "Menginstall Paket Kernel Xanmod (x64v3 Stable)..."
    apt-get update -qq
    
    if apt-get install linux-xanmod-x64v3 -y; then
        print_success "Kernel x64v3 berhasil diinstall!"
    else
        print_info "Versi v3 tidak cocok, mencoba versi v2..."
        apt-get install linux-xanmod-x64v2 -y
    fi

    show_success_art "KERNEL XANMOD BERHASIL DIINSTALL"
    echo -e "${RED}PENTING: ANDA HARUS REBOOT (RESTART) VPS SEKARANG!${NC}"
    echo -e "${YELLOW}Setelah Reboot, jalankan script ini lagi dan pilih MENU 2.${NC}"
    
    echo ""
    read -p "Reboot sekarang? (y/n): " reboot_now
    if [[ "$reboot_now" == "y" || "$reboot_now" == "Y" ]]; then
        echo -e "${GREEN}Sistem sedang Reboot... Sampai jumpa!${NC}"
        reboot
        exit 0
    fi
}

# === BAGIAN 2: TITAN NETWORK TUNING (TURBO) ===
apply_titan_tuning() {
    print_info "Menerapkan TITAN Network Logic..."
    
    cp "$CONFIG_FILE" "$BACKUP_FILE"
    
    sed -i '/net.core.default_qdisc/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_congestion_control/d' $CONFIG_FILE
    sed -i '/net.core.somaxconn/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_rmem/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_wmem/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_mtu_probing/d' $CONFIG_FILE
    sed -i '/fs.file-max/d' $CONFIG_FILE

    modprobe tcp_bbr 2>/dev/null
    echo "tcp_bbr" >> /etc/modules-load.d/modules.conf 2>/dev/null

    cat >> $CONFIG_FILE <<EOF
# --- TITAN XANMOD ULTIMATE TUNING ---
net.core.default_qdisc = fq
net.ipv4.tcp_congestion_control = bbr
fs.file-max = 2097152
net.core.somaxconn = 65535
net.core.netdev_max_backlog = 250000
net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.ipv4.tcp_rmem = 4096 87380 67108864
net.ipv4.tcp_wmem = 4096 65536 67108864
net.ipv4.tcp_mtu_probing = 1
net.ipv4.ip_forward = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_adv_win_scale = -2
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_fastopen = 3
EOF
    
    sysctl -p > /dev/null
    
    if ! grep -q "ulimit -SHn 1000000" /etc/profile; then
        echo "ulimit -SHn 1000000" >> /etc/profile
    fi
    
    show_success_art "TITAN TUNING BERHASIL DITERAPKAN"
}

remove_tuning() {
    sed -i '/TITAN XANMOD/d' $CONFIG_FILE
    sed -i '/net.core.default_qdisc/d' $CONFIG_FILE
    sed -i '/net.ipv4.tcp_congestion_control/d' $CONFIG_FILE
    echo "net.core.default_qdisc = fq_codel" >> $CONFIG_FILE
    echo "net.ipv4.tcp_congestion_control = cubic" >> $CONFIG_FILE
    sysctl -p > /dev/null
    echo "Tuning dihapus. Kembali ke default."
}

# === MAIN MENU ===
while true; do
    show_banner
    # Cek Virtualisasi untuk pewarnaan menu
    VIRT_DATA=$(get_virt_type)
    VIRT_TYPE=$(echo $VIRT_DATA | cut -d'|' -f1)
    
    if [[ "$VIRT_TYPE" != "kvm" && "$VIRT_TYPE" != "oracle" && "$VIRT_TYPE" != "vmware" ]]; then
        # Jika bukan KVM, Menu 1 diwarnai Merah (Tanda Dilarang)
        echo -e "${RED} [1] ${NC} Install Kernel Xanmod (TIDAK SUPPORT DI VPS INI)"
    else
        echo -e "${YELLOW} [1] ${NC} Install Kernel Xanmod (High Performance)"
    fi

    echo -e "${YELLOW} [2] ${NC} ðŸš€ Aktifkan TITAN BBR + Ultimate Tuning"
    echo -e "${YELLOW} [3] ${NC} Cek Status Kernel & BBR"
    echo -e "${YELLOW} [4] ${NC} Hapus Tuning (Restore Default)"
    echo -e "${YELLOW} [5] ${NC} Keluar"
    echo ""
    echo -e -n "${CYAN} Pilih Menu [1-5]: ${NC}"
    read choice

    case $choice in
        1) install_xanmod; read -p "Tekan Enter..." ;;
        2) apply_titan_tuning; read -p "Tekan Enter..." ;;
        3) uname -r; sysctl net.ipv4.tcp_congestion_control; read -p "Tekan Enter..." ;;
        4) remove_tuning; read -p "Tekan Enter..." ;;
        5) exit 0 ;;
        *) print_error "Pilihan salah!"; sleep 1 ;;
    esac
done
